# Copyright (c) 2025-Present : Ram Shanker: All rights reserved.
name: Nightly Build

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  update-nightly:
    runs-on: windows-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        # This ensures that submodules are also checked out.
        submodules: recursive
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1

    - name: Prepare libpng config header
      shell: pwsh
      run: |
        $src = "code-external/libpng-code/scripts/pnglibconf.h.prebuilt"
        $dst = "code-external/libpng-code/pnglibconf.h"
        if (!(Test-Path $dst)) {
          Copy-Item $src $dst
        }

    - name: Build
      #run: msbuild Vishwakarma.sln /p:Configuration=Release /p:Platform=x64
      # We are forcing to downgrade to v143 since this is what is available on GitHub Actions runners.
      run: msbuild Vishwakarma.sln /p:Configuration=Release /p:Platform=x64 /p:PlatformToolset=v143

    # DEBUG STEP: Verify the file actually exists
    - name: Verify Executable Exists
      run: |
        if (Test-Path "build/Release/Vishwakarma.exe") {
            Write-Host "File found!"
        } else {
            Write-Error "File NOT found at build/Release/Vishwakarma.exe"
            Get-ChildItem -Recurse *.exe # List all .exes so we can see where it went
            exit 1
        }

    - name: Count Lines of Code
      shell: pwsh
      run: |
        choco install cloc -y --no-progress --limit-output | Out-Null
        cloc . --exclude-dir=code-external,build,.git `
          --include-ext=cpp,h,hpp,hlsl,md,css,js,html `
          --json --quiet --out=cloc.json

    - name: Generate LOC Badge XML
      shell: pwsh
      run: |
        $json = Get-Content cloc.json | ConvertFrom-Json
        $loc = $json.SUM.code

        $svg = @(
          '<svg xmlns="http://www.w3.org/2000/svg" width="160" height="20">',
          '  <linearGradient id="a" x2="0" y2="100%">',
          '    <stop offset="0" stop-color="#bbb" stop-opacity=".1"/>',
          '    <stop offset="1" stop-opacity=".1"/>',
          '  </linearGradient>',
          '  <rect rx="3" width="160" height="20" fill="#555"/>',
          '  <rect rx="3" x="80" width="80" height="20" fill="#007ec6"/>',
          '  <path fill="#007ec6" d="M80 0h4v20h-4z"/>',
          '  <rect rx="3" width="160" height="20" fill="url(#a)"/>',
          '  <g fill="#fff" text-anchor="middle"',
          '     font-family="Verdana,Geneva,DejaVu Sans,sans-serif"',
          '     font-size="11">',
          '    <text x="40" y="14">LOC</text>',
          "    <text x=""120"" y=""14"">$loc</text>",
          '  </g>',
          '</svg>'
        )
        $svg | Out-File loc-badge.svg -Encoding utf8

    - name: Generate LOC JSON
      shell: pwsh
      run: |
        # Read cloc output
        $clocData = Get-Content cloc.json | ConvertFrom-Json
        $loc = $clocData.SUM.code
        
        # Create Shields.io compliant JSON schema
        $endpointData = @{
            schemaVersion = 1
            label = "LOC"
            message = $loc.ToString()
            color = "blue"
        }
        
        # Save to loc.json
        $endpointData | ConvertTo-Json -Compress | Out-File loc.json -Encoding utf8

    - name: Publish badge branch
      shell: pwsh
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        # Create fresh orphan branch
        git checkout --orphan ci
        # Remove everything from git index (not working directory)
        git rm -rf . --ignore-unmatch
        # Now only add the badge file
        git add loc-badge.svg loc.json
        git commit -m "Update LOC badge"
        git push origin ci --force
        
    # Use GitHub CLI to cleanly wipe the old release and create a new one
    - name: Publish Nightly Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      shell: pwsh
      run: |
        gh release delete nightly --cleanup-tag -y || echo "No existing nightly release to delete"
        # Create the new release and upload the file
        gh release create nightly `
          build/Release/Vishwakarma.exe `
          --title "Nightly Build" `
          --notes "Latest development build, automatically generated." `
          --prerelease

